<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calm Hub ‚Äì Day & Study Planner</title>
  <style>
    :root {
      --bg-shell: rgba(15,23,42,0.96);
      --bg-panel: #020617;
      --border-strong: rgba(148,163,184,0.7);
      --border-soft: #111827;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --slot-bg: #020617;
    }
    body.light-mode {
      --bg-shell: rgba(255,255,255,0.94);
      --bg-panel: #f9fafb;
      --border-strong: rgba(148,163,184,0.6);
      --border-soft: #e5e7eb;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --slot-bg: #ffffff;
    }

    * {
      margin:0; padding:0; box-sizing:border-box;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,sans-serif;
      -webkit-font-smoothing:antialiased;
    }

    body {
      min-height:100vh;
      background:linear-gradient(135deg,rgba(79,70,229,0.15),rgba(236,72,153,0.15)),#0f172a;
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      background-attachment:fixed;
      padding:24px;
      color:var(--text-main);
    }

    .shell {
      max-width:1200px;
      margin:0 auto;
      background:var(--bg-shell);
      backdrop-filter:blur(24px) saturate(180%);
      -webkit-backdrop-filter:blur(24px) saturate(180%);
      border-radius:28px;
      border:1px solid var(--border-strong);
      box-shadow:0 30px 80px rgba(0,0,0,0.8),0 0 0 1px rgba(15,23,42,0.9);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .header {
      padding:14px 20px;
      border-bottom:1px solid var(--border-soft);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .header-left { display:flex; align-items:center; gap:10px; }
    .dot-logo { width:26px;height:26px;border-radius:50%;border:3px solid #f97373;background:#020617; }

    .title-stack { display:flex;flex-direction:column;gap:2px; }
    .app-title { font-size:16px;font-weight:600; }
    .mode-subtitle { font-size:12px;color:var(--text-muted); }

    .header-right { display:flex;gap:10px;align-items:center;flex-wrap:wrap; }

    .back-btn,.theme-btn,.routine-btn,.export-btn {
      border-radius:999px;
      border:1px solid #4b5563;
      background:var(--bg-panel);
      color:var(--text-main);
      padding:6px 14px;
      font-size:13px;
      cursor:pointer;
      transition: all 0.2s;
    }
    .routine-btn {
      background: linear-gradient(135deg, #f97373, #ec4899);
      color: #fff;
      border-color: transparent;
      font-weight: 600;
    }
    .routine-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(249,115,115,0.4);
    }
    .export-btn { font-size:12px; }

    .planner-mode-group,.view-chip-group {
      display:inline-flex;
      background:var(--bg-panel);
      border-radius:999px;
      padding:3px;
      border:1px solid #1f2937;
    }
    body.light-mode .planner-mode-group,
    body.light-mode .view-chip-group {
      border-color:#cbd5e1;
    }

    .planner-mode,.view-chip {
      border-radius:999px;border:none;
      padding:5px 12px;
      font-size:12px;
      cursor:pointer;
      font-weight:600;
      color:var(--text-muted);
      background:transparent;
    }
    .planner-mode.active,.view-chip.active {
      background:#f97373;
      color:#111827;
    }

    .routine-banner {
      background: linear-gradient(135deg, rgba(249,115,115,0.15), rgba(236,72,153,0.15));
      border-bottom: 1px solid var(--border-soft);
      padding: 12px 20px;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .routine-banner.show { display: flex; }
    .routine-banner-text {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-main);
    }
    .routine-badge {
      background: linear-gradient(135deg, #f97373, #ec4899);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .clear-routine {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-main);
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 11px;
      cursor: pointer;
      font-weight: 600;
    }

    .pomodoro-bar {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border-soft);
      background: radial-gradient(circle at left, rgba(249,115,115,0.35), transparent 60%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .pomodoro-main { display:flex; align-items:center; }
    .pomodoro-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }
    .pomodoro-time {
      font-family: "SF Mono","Menlo",monospace;
      font-size: 26px;
      font-weight: 700;
    }
    .pomodoro-status {
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(248,250,252,0.12);
      margin-top: 2px;
    }
    .pomodoro-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pomodoro-btn {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: #111827;
      background: #f97373;
    }
    .pomodoro-btn.secondary {
      background: transparent;
      color: var(--text-main);
      border: 1px solid #4b5563;
    }

    .week-bar {
      padding:10px 20px 0;
      display:flex;
      justify-content:space-between;
      font-size:13px;
      color:var(--text-muted);
      flex-wrap:wrap;
      gap:6px;
    }
    .day-pill {display:flex;flex-direction:column;align-items:center;gap:4px;}
    .day-pill span:first-child{font-weight:600;}
    .day-pill .date{padding:4px 9px;border-radius:999px;border:1px solid transparent;cursor:pointer;}
    .day-pill .date.active{background:#f97373;color:#111827;border-color:#f97373;}

    .view-panel{padding:10px 16px 20px;display:none;}
    .view-panel.active{display:block;}

    .planner-grid{
      min-width:400px;
      display:grid;
      grid-template-columns:60px 1fr;
      grid-auto-rows:50px;
      gap:4px;
    }
    .time-cell{
      font-size:11px;
      color:var(--text-muted);
      text-align:right;
      padding-right:8px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
    }
    .slot-cell{
      background:var(--slot-bg);
      border-radius:8px;
      border:1px solid var(--border-soft);
      position:relative;
      overflow:hidden;
      cursor:pointer;
      transition:border-color .15s,background .15s;
      min-height:50px;
    }
    .slot-cell:hover{border-color:#4b5563;}
    .slot-cell.drag-over { outline:2px dashed #f97373; }

    .event{
      position:absolute;left:4px;right:4px;top:4px;
      border-radius:6px;padding:6px 8px;
      font-size:11px;color:#111827;
      display:flex;justify-content:space-between;gap:4px;
      align-items:center;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;
    }
    .event.study{background:#e0f2fe;border-left:3px solid #38bdf8;}
    .event.wellness{background:#dcfce7;border-left:3px solid #22c55e;}
    .event.other{background:#fef3c7;border-left:3px solid #fbbf24;}
    .event.social{background:#fce7f3;border-left:3px solid #ec4899;}
    .event.completed {
      opacity:0.55;
      text-decoration:line-through;
    }
    .event[draggable="true"] { cursor:grab; }
    .event.recurring { border-right:3px solid rgba(0,0,0,0.2); }

    .event-title{flex:1;overflow:hidden;text-overflow:ellipsis;}
    .event-left {
      display:flex;
      align-items:center;
      gap:4px;
      overflow:hidden;
    }
    .event-check {
      width:13px;
      height:13px;
      border-radius:3px;
      border:1px solid #6b7280;
      background:#f9fafb;
      flex-shrink:0;
    }
    .event-check.checked {
      background:#22c55e;
      border-color:#22c55e;
    }
    .event-delete{cursor:pointer;color:#4b5563;padding:0 4px;font-size:14px;}
    .event-delete:hover{color:#f97373;}

    .week-grid{
      min-width:700px;
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:8px;
    }
    .week-day-box{
      background:var(--slot-bg);
      border-radius:10px;
      border:1px solid var(--border-soft);
      padding:8px 10px;
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .week-day-header{display:flex;justify-content:space-between;color:var(--text-muted);font-weight:500;}
    .badge-row{display:flex;gap:4px;flex-wrap:wrap;}
    .badge-dot{width:8px;height:8px;border-radius:50%;}
    .badge-study{background:#38bdf8;}
    .badge-wellness{background:#22c55e;}
    .badge-other{background:#fbbf24;}
    .badge-social{background:#ec4899;}

    .month-grid{
      min-width:700px;
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:8px;
      font-size:12px;
    }
    .month-cell{
      background:var(--slot-bg);
      border-radius:10px;
      border:1px solid var(--border-soft);
      padding:6px;
      min-height:70px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      cursor:pointer;
    }
    .month-cell.inactive{opacity:.3;}
    .month-date{align-self:flex-end;color:var(--text-muted);font-weight:500;}
    .month-dot-row{display:flex;gap:3px;margin-top:4px;flex-wrap:wrap;}
    .month-dot{width:5px;height:5px;border-radius:50%;}
    .month-dot.study{background:#38bdf8;}
    .month-dot.wellness{background:#22c55e;}
    .month-dot.other{background:#fbbf24;}
    .month-dot.social{background:#ec4899;}

    .quick-add{
      padding:10px 20px 12px;
      border-top:1px solid var(--border-soft);
      display:flex;
      gap:8px;
      align-items:center;
      font-size:13px;
      background:var(--bg-panel);
      flex-wrap:wrap;
    }
    .quick-add input,
    .quick-add select{
      background:var(--bg-panel);
      border-radius:8px;
      border:1px solid #374151;
      color:var(--text-main);
      padding:6px 10px;
      font-size:13px;
    }
    body.light-mode .quick-add input,
    body.light-mode .quick-add select{
      border-color:#cbd5e1;
    }
    .quick-add button{
      border-radius:8px;
      border:none;
      background:#f97373;
      color:#111827;
      font-weight:600;
      padding:6px 14px;
      cursor:pointer;
      font-size:13px;
    }

    .selfcare-templates {
      padding:8px 20px 10px;
      border-top:1px solid var(--border-soft);
      background:var(--bg-panel);
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:12px;
    }
    .selfcare-templates span { color:var(--text-muted); }
    .selfcare-chip {
      border-radius:999px;
      border:1px solid #4b5563;
      background:#020617;
      color:var(--text-main);
      padding:4px 10px;
      font-size:11px;
      cursor:pointer;
    }

    .footer-bar {
      padding:6px 20px 10px;
      border-top:1px solid var(--border-soft);
      font-size:12px;
      color:var(--text-muted);
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:6px;
      background:var(--bg-panel);
    }
    .footer-bar strong { color:#f97373; }

    @media (max-width:600px){
      body{padding:16px;}
      .shell{border-radius:22px;}
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="header-left">
        <div class="dot-logo"></div>
        <div class="title-stack">
          <div class="app-title" id="plannerTitle">Day Planner</div>
          <div class="mode-subtitle" id="plannerSubtitle">Plan your whole day with tasks, breaks and self‚Äëcare.</div>
        </div>
      </div>
      <div class="header-right">
        <button class="routine-btn" onclick="window.location.href='routines.html'">üìã Routine Templates</button>
        <button class="back-btn" onclick="window.location.href='journey.html'">‚Üê Back to Calm Hub</button>
        <button class="theme-btn" id="themeToggle">‚òæ Dark</button>
        <button class="export-btn" onclick="exportToICS()">üì§ Export .ics</button>
        <div class="planner-mode-group">
          <button class="planner-mode active" data-mode="day">Day Planner</button>
          <button class="planner-mode" data-mode="study">Study Planner</button>
        </div>
        <div class="view-chip-group">
          <button class="view-chip active" data-view="day">Day</button>
          <button class="view-chip" data-view="week">Week</button>
          <button class="view-chip" data-view="month">Month</button>
        </div>
      </div>
    </div>

    <div class="pomodoro-bar">
      <div class="pomodoro-main">
        <div>
          <div class="pomodoro-label">Focus timer</div>
          <div style="display:flex;align-items:baseline;gap:8px;">
            <span class="pomodoro-time" id="pomodoroTime">25:00</span>
            <span class="pomodoro-status" id="pomodoroStatus">Work</span>
          </div>
        </div>
      </div>
      <div class="pomodoro-actions">
        <button class="pomodoro-btn" onclick="startPomodoro()">Start</button>
        <button class="pomodoro-btn secondary" onclick="resetPomodoro()">Reset</button>
      </div>
    </div>

    <div class="routine-banner" id="routineBanner">
      <div class="routine-banner-text">
        <span>üìã</span>
        <span id="routineCount">0 routine tasks</span>
        <span class="routine-badge" id="routineName">Routine Active</span>
      </div>
      <button class="clear-routine" id="clearRoutine">Clear Routine Tasks</button>
    </div>

    <div class="week-bar" id="weekBar"></div>

    <div class="view-panel active" id="dayView">
      <div style="overflow:auto;">
        <div class="planner-grid" id="plannerGrid"></div>
      </div>
    </div>

    <div class="view-panel" id="weekView">
      <div style="overflow:auto;">
        <div class="week-grid" id="weekGrid"></div>
      </div>
    </div>

    <div class="view-panel" id="monthView">
      <div style="overflow:auto;">
        <div class="month-grid" id="monthGrid"></div>
      </div>
    </div>

    <div class="quick-add">
      <span style="color:var(--text-muted);">Quick add:</span>
      <input id="taskTitle" type="text" placeholder="Task / subject" />
      <select id="taskType">
        <option value="study">Study</option>
        <option value="wellness">Wellness</option>
        <option value="social">Social</option>
        <option value="other">Other</option>
      </select>
      <select id="taskHour"></select>
      <input id="taskDate" type="date" />
      <select id="taskRepeat">
        <option value="">One-time</option>
        <option value="daily">Repeat daily</option>
        <option value="weekly">Repeat weekly</option>
      </select>
      <button id="addBtn">Add</button>
    </div>

    <div class="selfcare-templates">
      <span>Self‚Äëcare presets:</span>
      <button class="selfcare-chip" onclick="addTemplate('Meditation',10,'wellness')">üßò Meditation 10:00</button>
      <button class="selfcare-chip" onclick="addTemplate('Journal',21,'wellness')">üìì Journal 21:00</button>
      <button class="selfcare-chip" onclick="addTemplate('Walk outside',18,'wellness')">üö∂ 18:00 Walk</button>
    </div>

    <div class="footer-bar">
      <div id="productivityText">Productivity: 0% (0 / 0 tasks)</div>
      <div style="font-size:11px;">Completed tasks turn faded with a ‚úì</div>
    </div>
  </div>

  <script>
    const hours = Array.from({ length: 24 }, (_, i) => i);
    const daysInWeek = 7;

    const plannerGrid = document.getElementById('plannerGrid');
    const weekGrid = document.getElementById('weekGrid');
    const monthGrid = document.getElementById('monthGrid');
    const weekBar = document.getElementById('weekBar');
    const routineBanner = document.getElementById('routineBanner');

    let currentDate = new Date();
    let selectedDateISO = toISO(new Date());

    // Store base recurring events separately
    let recurringEvents = JSON.parse(localStorage.getItem('calmRecurringEvents') || '[]');
    
    // Events stored as { [isoDate]: [ {id,hour,title,type,completed,repeat,parentId} ] }
    let dayEvents   = JSON.parse(localStorage.getItem('calmDayEventsByDate')   || '{}');
    let studyEvents = JSON.parse(localStorage.getItem('calmStudyEventsByDate') || '{}');

    let currentMode = 'day';

    function eventsMap() {
      return currentMode === 'day' ? dayEvents : studyEvents;
    }

    function saveEvents() {
      localStorage.setItem('calmDayEventsByDate',   JSON.stringify(dayEvents));
      localStorage.setItem('calmStudyEventsByDate', JSON.stringify(studyEvents));
      localStorage.setItem('calmRecurringEvents', JSON.stringify(recurringEvents));
      updateRoutineBanner();
      updateProductivity();
    }

    function toISO(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseISO(isoString) {
      const [year, month, day] = isoString.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function formatHour(h) {
      return `${h.toString().padStart(2,'0')}:00`;
    }

    function getDayOfWeek(isoString) {
      const date = parseISO(isoString);
      return date.getDay();
    }

    // Generate recurring event instances for a date range
    function generateRecurringInstances(startDate, endDate) {
      const start = parseISO(startDate);
      const end = parseISO(endDate);
      
      recurringEvents.forEach(baseEvent => {
        const baseDate = parseISO(baseEvent.startDate);
        const baseDay = baseDate.getDay();
        
        // Generate instances from base date to end date
        let currentDate = new Date(Math.max(baseDate, start));
        
        while (currentDate <= end) {
          const iso = toISO(currentDate);
          
          let shouldCreate = false;
          
          if (baseEvent.repeat === 'daily') {
            shouldCreate = true;
          } else if (baseEvent.repeat === 'weekly') {
            // Check if same day of week as base date
            if (currentDate.getDay() === baseDay) {
              shouldCreate = true;
            }
          }
          
          if (shouldCreate) {
            const map = baseEvent.mode === 'day' ? dayEvents : studyEvents;
            if (!map[iso]) map[iso] = [];
            
            // Check if instance already exists for this date
            const exists = map[iso].some(e => e.parentId === baseEvent.id);
            if (!exists) {
              map[iso].push({
                id: Date.now() + Math.floor(Math.random() * 100000),
                hour: baseEvent.hour,
                title: baseEvent.title,
                type: baseEvent.type,
                completed: false,
                repeat: baseEvent.repeat,
                parentId: baseEvent.id
              });
            }
          }
          
          // Move to next day
          currentDate.setDate(currentDate.getDate() + 1);
        }
      });
    }

    // Get events for a specific date (including recurring instances)
    function getEventsForDate(dateISO) {
      // Generate instances for a range around this date
      const date = parseISO(dateISO);
      const startRange = new Date(date);
      startRange.setDate(date.getDate() - 7);
      const endRange = new Date(date);
      endRange.setDate(date.getDate() + 60); // Generate 60 days ahead
      
      generateRecurringInstances(toISO(startRange), toISO(endRange));
      
      const map = eventsMap();
      return map[dateISO] || [];
    }

    function getRoutineTasks(date) {
      const tasks = getEventsForDate(date);
      const routineEmojis = ['üíî', 'üò∞', 'üåßÔ∏è', 'üßò', '‚ö°', 'ü§ù', 'üò¥', 'üìã'];
      return tasks.filter(task =>
        routineEmojis.some(emoji => task.title.startsWith(emoji))
      );
    }

    function updateRoutineBanner() {
      const todayISO = toISO(new Date());
      const routineTasks = getRoutineTasks(todayISO);
      if (routineTasks.length > 0) {
        routineBanner.classList.add('show');
        document.getElementById('routineCount').textContent =
          `${routineTasks.length} routine task${routineTasks.length > 1 ? 's' : ''} scheduled today`;
        const firstTask = routineTasks[0].title;
        let routineType = 'Routine';
        if (firstTask.startsWith('üíî')) routineType = 'Heartbreak Healing';
        else if (firstTask.startsWith('üò∞')) routineType = 'Anxiety Reset';
        else if (firstTask.startsWith('üåßÔ∏è')) routineType = 'Small Steps Forward';
        else if (firstTask.startsWith('üßò')) routineType = 'Calm the System';
        else if (firstTask.startsWith('‚ö°')) routineType = 'Start with Energy';
        else if (firstTask.startsWith('ü§ù')) routineType = 'Find Support';
        else if (firstTask.startsWith('üò¥')) routineType = 'Wind Down Early';
        document.getElementById('routineName').textContent = routineType;
      } else {
        routineBanner.classList.remove('show');
      }
    }

    document.getElementById('clearRoutine').addEventListener('click', function() {
      const todayISO = toISO(new Date());
      const map = eventsMap();
      if (map[todayISO]) {
        const routineEmojis = ['üíî', 'üò∞', 'üåßÔ∏è', 'üßò', '‚ö°', 'ü§ù', 'üò¥', 'üìã'];
        map[todayISO] = map[todayISO].filter(task =>
          !routineEmojis.some(emoji => task.title.startsWith(emoji))
        );
        if (map[todayISO].length === 0) {
          delete map[todayISO];
        }
        saveEvents();
        buildDayGrid();
        buildWeekView();
        buildMonthView();
      }
    });

    const hourSelect = document.getElementById('taskHour');
    hours.forEach(h => {
      const opt = document.createElement('option');
      opt.value = h;
      opt.textContent = formatHour(h);
      hourSelect.appendChild(opt);
    });

    document.getElementById('taskDate').valueAsDate = new Date();

    function buildWeekBar() {
      weekBar.innerHTML = '';
      const startOfWeek = new Date(currentDate);
      const dayOfWeek = startOfWeek.getDay();
      startOfWeek.setDate(startOfWeek.getDate() - dayOfWeek);
      const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

      for (let i = 0; i < daysInWeek; i++) {
        const d = new Date(startOfWeek);
        d.setDate(startOfWeek.getDate() + i);
        const iso = toISO(d);

        const wrap = document.createElement('div');
        wrap.className = 'day-pill';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = dayNames[i];

        const dateSpan = document.createElement('span');
        dateSpan.className = 'date' + (iso === selectedDateISO ? ' active' : '');
        dateSpan.textContent = d.getDate();
        dateSpan.onclick = () => {
          selectedDateISO = iso;
          buildWeekBar();
          buildDayGrid();
        };

        wrap.appendChild(nameSpan);
        wrap.appendChild(dateSpan);
        weekBar.appendChild(wrap);
      }
    }

    function buildDayGrid() {
      plannerGrid.innerHTML = '';
      hours.forEach(h => {
        const label = document.createElement('div');
        label.className = 'time-cell';
        label.textContent = formatHour(h);
        plannerGrid.appendChild(label);

        const cell = document.createElement('div');
        cell.className = 'slot-cell';
        cell.dataset.hour = h;
        cell.addEventListener('dragover', onCellDragOver);
        cell.addEventListener('dragleave', onCellDragLeave);
        cell.addEventListener('drop', onCellDrop);
        plannerGrid.appendChild(cell);
      });
      renderDayEvents();
    }

    function renderDayEvents() {
      plannerGrid.querySelectorAll('.slot-cell').forEach(c => c.innerHTML = '');
      
      const list = getEventsForDate(selectedDateISO);
      
      list.forEach(e => {
        const cell = plannerGrid.querySelector(`.slot-cell[data-hour="${e.hour}"]`);
        if (!cell) return;

        const div = document.createElement('div');
        div.className = 'event ' + e.type + (e.completed ? ' completed' : '') + (e.repeat ? ' recurring' : '');
        div.draggable = true;
        div.dataset.id = e.id;
        div.addEventListener('dragstart', onEventDragStart);

        const left = document.createElement('div');
        left.className = 'event-left';

        const check = document.createElement('div');
        check.className = 'event-check' + (e.completed ? ' checked' : '');
        check.onclick = (ev) => {
          ev.stopPropagation();
          toggleComplete(selectedDateISO, e.id);
        };

        const titleSpan = document.createElement('span');
        titleSpan.className = 'event-title';
        const repeatTag = e.repeat ? ` üîÅ` : '';
        titleSpan.textContent = `${formatHour(e.hour)} ‚Äì ${e.title}${repeatTag}`;

        left.appendChild(check);
        left.appendChild(titleSpan);

        const del = document.createElement('span');
        del.className = 'event-delete';
        del.textContent = '√ó';
        del.onclick = (ev) => {
          ev.stopPropagation();
          deleteEvent(selectedDateISO, e.id);
        };

        div.appendChild(left);
        div.appendChild(del);
        cell.appendChild(div);
      });
    }

    function buildWeekView() {
      weekGrid.innerHTML = '';
      const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      const startOfWeek = new Date(currentDate);
      const dayOfWeek = startOfWeek.getDay();
      startOfWeek.setDate(startOfWeek.getDate() - dayOfWeek);

      for (let i = 0; i < daysInWeek; i++) {
        const d = new Date(startOfWeek);
        d.setDate(startOfWeek.getDate() + i);
        const iso = toISO(d);

        const box = document.createElement('div');
        box.className = 'week-day-box';

        const header = document.createElement('div');
        header.className = 'week-day-header';
        header.innerHTML = `<span>${dayNames[i]}</span><span>${d.getDate()}</span>`;
        box.appendChild(header);

        const badges = document.createElement('div');
        badges.className = 'badge-row';
        const todays = getEventsForDate(iso);
        todays.forEach(e => {
          const dot = document.createElement('div');
          let cls = 'badge-other';
          if (e.type === 'study') cls = 'badge-study';
          else if (e.type === 'wellness') cls = 'badge-wellness';
          else if (e.type === 'social') cls = 'badge-social';
          dot.className = 'badge-dot ' + cls;
          badges.appendChild(dot);
        });
        if (todays.length === 0) {
          const span = document.createElement('span');
          span.style.color = '#4b5563';
          span.textContent = currentMode === 'day' ? 'No tasks' : 'No study';
          badges.appendChild(span);
        }
        box.appendChild(badges);
        weekGrid.appendChild(box);
      }
    }

    function buildMonthView() {
      monthGrid.innerHTML = '';
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const firstWeekday = firstDay.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const totalCells = Math.ceil((firstWeekday + daysInMonth) / 7) * 7;

      for (let cell = 0; cell < totalCells; cell++) {
        const div = document.createElement('div');
        div.className = 'month-cell';
        const dateNum = cell - firstWeekday + 1;
        let thisDate = null;

        if (dateNum < 1 || dateNum > daysInMonth) {
          div.classList.add('inactive');
        } else {
          thisDate = new Date(year, month, dateNum);
        }

        const dateEl = document.createElement('div');
        dateEl.className = 'month-date';
        dateEl.textContent = thisDate ? thisDate.getDate() : '';
        div.appendChild(dateEl);

        const row = document.createElement('div');
        row.className = 'month-dot-row';

        if (thisDate) {
          const iso = toISO(thisDate);
          const todays = getEventsForDate(iso);
          todays.forEach(e => {
            const dot = document.createElement('div');
            let cls = 'other';
            if (e.type === 'study') cls = 'study';
            else if (e.type === 'wellness') cls = 'wellness';
            else if (e.type === 'social') cls = 'social';
            dot.className = 'month-dot ' + cls;
            row.appendChild(dot);
          });
          div.onclick = () => {
            selectedDateISO = iso;
            buildWeekBar();
            buildDayGrid();
            document.querySelectorAll('.view-chip').forEach(b => b.classList.remove('active'));
            document.querySelector('.view-chip[data-view="day"]').classList.add('active');
            document.getElementById('dayView').classList.add('active');
            document.getElementById('weekView').classList.remove('active');
            document.getElementById('monthView').classList.remove('active');
          };
        }

        div.appendChild(row);
        monthGrid.appendChild(div);
      }
    }

    function addEvent() {
      const title = document.getElementById('taskTitle').value.trim();
      if (!title) return;

      const hour = parseInt(document.getElementById('taskHour').value, 10);
      const dateInput = document.getElementById('taskDate').value;
      const iso = dateInput || toISO(currentDate);

      const type = currentMode === 'study'
        ? 'study'
        : document.getElementById('taskType').value;

      const repeat = document.getElementById('taskRepeat').value || '';

      if (repeat) {
        // Create recurring base event
        const baseEvent = {
          id: Date.now() + Math.floor(Math.random() * 100000),
          startDate: iso,
          hour,
          title,
          type,
          repeat,
          mode: currentMode
        };
        recurringEvents.push(baseEvent);
      } else {
        // Create one-time event
        const map = eventsMap();
        if (!map[iso]) map[iso] = [];
        map[iso].push({
          id: Date.now() + Math.floor(Math.random() * 1000),
          hour,
          title,
          type,
          completed: false,
          repeat: ''
        });
      }

      document.getElementById('taskTitle').value = '';
      document.getElementById('taskRepeat').value = '';
      saveEvents();
      buildWeekBar();
      buildDayGrid();
      buildWeekView();
      buildMonthView();
    }
    document.getElementById('addBtn').onclick = addEvent;

    function deleteEvent(iso, id) {
      const map = eventsMap();
      if (!map[iso]) return;
      
      const event = map[iso].find(e => e.id === id);
      
      // If it's a recurring event instance, remove the parent
      if (event && event.parentId) {
        recurringEvents = recurringEvents.filter(e => e.id !== event.parentId);
        // Clear all generated instances from both maps
        [dayEvents, studyEvents].forEach(eventMap => {
          Object.keys(eventMap).forEach(dateKey => {
            eventMap[dateKey] = eventMap[dateKey].filter(e => e.parentId !== event.parentId);
            if (eventMap[dateKey].length === 0) delete eventMap[dateKey];
          });
        });
      } else {
        // Remove single instance
        map[iso] = map[iso].filter(e => e.id !== id);
        if (map[iso].length === 0) delete map[iso];
      }
      
      saveEvents();
      buildDayGrid();
      buildWeekView();
      buildMonthView();
    }
    window.deleteEvent = deleteEvent;

    function toggleComplete(iso, id) {
      const map = eventsMap();
      const list = map[iso] || [];
      const item = list.find(e => e.id === id);
      if (!item) return;
      item.completed = !item.completed;
      saveEvents();
      renderDayEvents();
    }

    function addTemplate(label, hour, type) {
      document.getElementById('taskTitle').value = label;
      document.getElementById('taskHour').value = hour;
      document.getElementById('taskType').value = type;
      document.getElementById('taskDate').valueAsDate = new Date();
      document.getElementById('taskRepeat').value = '';
      addEvent();
    }
    window.addTemplate = addTemplate;

    document.querySelectorAll('.view-chip').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.view-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const view = btn.dataset.view;
        document.getElementById('dayView').classList.toggle('active', view === 'day');
        document.getElementById('weekView').classList.toggle('active', view === 'week');
        document.getElementById('monthView').classList.toggle('active', view === 'month');
      });
    });

    document.querySelectorAll('.planner-mode').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.planner-mode').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode;

        const titleEl = document.getElementById('plannerTitle');
        const subEl = document.getElementById('plannerSubtitle');
        const typeSel = document.getElementById('taskType');

        if (currentMode === 'day') {
          titleEl.textContent = 'Day Planner';
          subEl.textContent = 'Plan your whole day with tasks, breaks and self‚Äëcare.';
          typeSel.disabled = false;
        } else {
          titleEl.textContent = 'Study Planner';
          subEl.textContent = 'Only subjects, chapters and revision ‚Äì nothing else.';
          typeSel.value = 'study';
          typeSel.disabled = true;
        }

        buildWeekBar();
        buildDayGrid();
        buildWeekView();
        buildMonthView();
        updateRoutineBanner();
      });
    });

    const themeBtn = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('calmPlannerTheme');
    if (savedTheme === 'light') {
      document.body.classList.add('light-mode');
      themeBtn.textContent = '‚òÄ Light';
    }
    themeBtn.addEventListener('click', () => {
      const isLight = document.body.classList.toggle('light-mode');
      themeBtn.textContent = isLight ? '‚òÄ Light' : '‚òæ Dark';
      localStorage.setItem('calmPlannerTheme', isLight ? 'light' : 'dark');
    });

    let draggingEventId = null;

    function onEventDragStart(e) {
      draggingEventId = e.currentTarget.dataset.id;
      e.dataTransfer.effectAllowed = 'move';
    }

    function onCellDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    function onCellDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function onCellDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      if (!draggingEventId) return;
      const newHour = parseInt(e.currentTarget.dataset.hour,10);
      const map = eventsMap();
      const list = map[selectedDateISO] || [];
      const item = list.find(ev => ev.id == draggingEventId);
      if (!item) return;
      item.hour = newHour;
      saveEvents();
      renderDayEvents();
      draggingEventId = null;
    }

    function updateProductivity() {
      const todayISO = toISO(new Date());
      const list = getEventsForDate(todayISO);
      const total = list.length;
      const completed = list.filter(e => e.completed).length;
      const percent = total ? Math.round((completed / total) * 100) : 0;
      const el = document.getElementById('productivityText');
      el.innerHTML = `Productivity: <strong>${percent}%</strong> (${completed} / ${total} tasks today)`;
    }

    let pomoSeconds = 25 * 60;
    let pomoMode = 'work';
    let pomoTimerId = null;

    function formatMMSS(total) {
      const m = Math.floor(total / 60);
      const s = total % 60;
      return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function updatePomoUI() {
      document.getElementById('pomodoroTime').textContent = formatMMSS(pomoSeconds);
      document.getElementById('pomodoroStatus').textContent = pomoMode === 'work' ? 'Work' : 'Break';
    }

    function tickPomodoro() {
      pomoSeconds--;
      if (pomoSeconds <= 0) {
        if (pomoMode === 'work') {
          alert('Nice work. Time for a 5‚Äëminute reset. üå±');
          pomoMode = 'break';
          pomoSeconds = 5 * 60;
        } else {
          alert('Ready for another focus block? üí™');
          pomoMode = 'work';
          pomoSeconds = 25 * 60;
        }
      }
      updatePomoUI();
    }

    function startPomodoro() {
      if (pomoTimerId) return;
      pomoTimerId = setInterval(tickPomodoro, 1000);
    }
    window.startPomodoro = startPomodoro;

    function resetPomodoro() {
      if (pomoTimerId) {
        clearInterval(pomoTimerId);
        pomoTimerId = null;
      }
      pomoMode = 'work';
      pomoSeconds = 25 * 60;
      updatePomoUI();
    }
    window.resetPomodoro = resetPomodoro;

    function exportToICS() {
      const allEvents = [];
      
      // Export one-time events
      [dayEvents, studyEvents].forEach(map => {
        Object.keys(map).forEach(dateISO => {
          map[dateISO].forEach(ev => {
            if (!ev.parentId) {
              allEvents.push({ dateISO, ev });
            }
          });
        });
      });
      
      // Export recurring events (30 days worth)
      recurringEvents.forEach(baseEvent => {
        const endDate = new Date(parseISO(baseEvent.startDate));
        endDate.setDate(endDate.getDate() + 30);
        let currentDate = new Date(parseISO(baseEvent.startDate));
        const baseDay = currentDate.getDay();
        
        while (currentDate <= endDate) {
          if (baseEvent.repeat === 'daily') {
            allEvents.push({ 
              dateISO: toISO(currentDate), 
              ev: { ...baseEvent, hour: baseEvent.hour } 
            });
          } else if (baseEvent.repeat === 'weekly' && currentDate.getDay() === baseDay) {
            allEvents.push({ 
              dateISO: toISO(currentDate), 
              ev: { ...baseEvent, hour: baseEvent.hour } 
            });
          }
          currentDate.setDate(currentDate.getDate() + 1);
        }
      });
      
      if (!allEvents.length) {
        alert('No events to export.');
        return;
      }

      let ics = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//CalmHub//Planner//EN\r\n';
      allEvents.forEach(({dateISO, ev}) => {
        const start = new Date(dateISO + 'T' + ev.hour.toString().padStart(2,'0') + ':00:00');
        const end = new Date(start.getTime() + 60*60*1000);
        function fmt(d) {
          return d.toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
        }
        ics += 'BEGIN:VEVENT\r\n';
        ics += 'SUMMARY:' + (ev.title.replace(/\r?\n/g,' ') || 'Task') + '\r\n';
        ics += 'DTSTART:' + fmt(start) + '\r\n';
        ics += 'DTEND:' + fmt(end) + '\r\n';
        ics += 'END:VEVENT\r\n';
      });
      ics += 'END:VCALENDAR\r\n';

      const blob = new Blob([ics], {type:'text/calendar;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'calm-planner.ics';
      a.click();
      URL.revokeObjectURL(url);
    }
    window.exportToICS = exportToICS;

    buildWeekBar();
    buildDayGrid();
    buildWeekView();
    buildMonthView();
    updateRoutineBanner();
    updateProductivity();
    updatePomoUI();
  </script>
</body>
</html>
